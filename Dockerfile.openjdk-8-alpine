FROM docker.io/openjdk:8-jdk-alpine
MAINTAINER ashmastaflash

ENV CONFIG_FILE=/app/osh-core/config.json

RUN apk add -U \
    bash \
    git


RUN mkdir /src
RUN mkdir /app

COPY ./ /src/

RUN cd /src/ && \
    ./gradlew tasks && \
    ./gradlew build && \
    export OSH_VER=`ls /src/build/distributions/*zip | head -1 | awk -F- '{print $3}' | sed 's/.zip//g'` && \
    echo "OSH Version: ${OSH_VER}" && \
    mv /src/build/distributions/osh-core-${OSH_VER}.zip \
       /app/osh-core.zip && \
    cd /app/ && \
    unzip ./osh-core.zip && \
    mv ./osh-core-${OSH_VER} ./osh-core && \
    cp /src/demo-assets/config.json \
       /src/demo-assets/logback.xml \
       /src/demo-assets/launch.sh \
       /app/osh-core/


EXPOSE 8181

WORKDIR /app/osh-core
CMD /app/osh-core/launch.sh
